<!doctype html>
<html lang="en" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Card Image Designer</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&family=Playfair+Display:wght@400;500;600;700&family=Montserrat:wght@400;500;600;700&family=Raleway:wght@400;500;600;700&family=Great+Vibes&family=Dancing+Script:wght@400;500;600;700&family=Pacifico&family=Sacramento&family=Allura&family=Satisfy&family=Lobster&family=Tangerine:wght@400;700&family=Cookie&display=swap" rel="stylesheet">
<style>
body{box-sizing:border-box}*{box-sizing:border-box}
.card-canvas{width:402px;height:240px;position:relative;background:white;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:visible;background-size:cover;background-position:center}
.design-zone{position:absolute;border:3px dashed #6366f1;background:rgba(99,102,241,0.05);cursor:move;user-select:none}
.design-zone:hover{background:rgba(99,102,241,0.1)}
.zone-label{position:absolute;top:-22px;left:0;font-size:11px;font-weight:600;color:#6366f1;letter-spacing:0.5px}
.placed-item{position:absolute;cursor:grab;user-select:none;pointer-events:auto!important}
.placed-item:active{cursor:grabbing}
.placed-item *{pointer-events:none}
.placed-item.selected{outline:2px solid #6366f1;outline-offset:1px;z-index:100}
.placed-item[data-type="text"].selected{outline:none!important;z-index:100!important}
.placed-item[data-type="text"].selected{box-shadow:0 0 0 2px white,0 0 0 4px #3b82f6}
.placed-item[data-type="text"]{z-index:50}
.item-content{width:100%;height:100%;display:flex;align-items:center;justify-content:center;pointer-events:none}
.item-content svg{width:100%;height:100%}
.item-content img{width:100%;height:100%;object-fit:cover}
.text-content{pointer-events:none;white-space:nowrap;padding:0;margin:0;line-height:1;vertical-align:top}
.resize-handle{position:absolute;width:16px;height:16px;background:#06b6d4;border:2px solid white;border-radius:50%;cursor:se-resize;bottom:-8px;right:-8px;box-shadow:0 2px 8px rgba(0,0,0,0.3);z-index:5;pointer-events:auto!important}
.rotate-handle{position:absolute;width:16px;height:16px;background:#fbbf24;border:2px solid white;border-radius:50%;cursor:grab;top:-8px;right:-8px;box-shadow:0 2px 8px rgba(0,0,0,0.3);z-index:5;pointer-events:auto!important}
.library-grid{display:flex;flex-wrap:wrap;gap:4px;width:100%}
.library-item{width:40px;height:40px;background:#334155;border-radius:4px;display:flex;align-items:center;justify-content:center;cursor:grab;border:1px solid #475569;transition:all 0.2s;padding:4px;flex:0 0 40px;color:#06b6d4}
.library-item:hover{background:#475569;border-color:#6366f1;transform:translateY(-2px)}
.library-item svg{width:100%;height:100%;color:inherit}
.checkerboard{background-image:linear-gradient(45deg,#ccc 25%,transparent 25%),linear-gradient(-45deg,#ccc 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#ccc 75%),linear-gradient(-45deg,transparent 75%,#ccc 75%);background-size:20px 20px;background-position:0 0,0 10px,10px -10px,-10px 0px}
.capture-mode .resize-handle,.capture-mode .rotate-handle,.capture-mode .zone-label{display:none!important}
.capture-mode .design-zone{border:none!important;background:transparent!important}
.capture-mode .placed-item.selected{outline:none!important;box-shadow:none!important}
.color-swatches{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.color-swatch{width:24px;height:24px;border-radius:4px;cursor:pointer;border:2px solid transparent;transition:all 0.15s}
.color-swatch:hover{transform:scale(1.1)}
.color-swatch.selected{border-color:white;box-shadow:0 0 0 2px #6366f1}
.color-picker-wrapper{position:relative;width:28px;height:28px;border-radius:4px;background:conic-gradient(red,yellow,lime,aqua,blue,magenta,red);padding:2px;cursor:pointer}
.color-picker-wrapper::after{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:12px;height:12px;background:white;border-radius:2px}
.color-picker-input{position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;cursor:pointer;z-index:10}
.font-dropdown{position:relative;width:100%}
.font-dropdown-btn{width:100%;background:#334155;color:white;border:1px solid #475569;border-radius:4px;padding:6px 10px;font-size:12px;cursor:pointer;text-align:left;display:flex;justify-content:space-between;align-items:center}
.font-dropdown-btn:hover{border-color:#6366f1}
.font-dropdown-list{position:absolute;top:100%;left:0;right:0;background:#1e293b;border:1px solid #475569;border-radius:4px;margin-top:2px;max-height:200px;overflow-y:auto;z-index:100;display:none}
.font-dropdown-list.open{display:block}
.font-dropdown-item{padding:8px 10px;cursor:pointer;color:white;font-size:16px;border-bottom:1px solid #334155}
.font-dropdown-item:last-child{border-bottom:none}
.font-dropdown-item:hover{background:#334155}
.font-dropdown-item.selected{background:#4f46e5}

.font-dropdown{position:relative}
.font-dropdown-selected{background:#374151;color:white;border:1px solid #4b5563;border-radius:4px;padding:6px 8px;font-size:12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;min-width:120px}
.font-dropdown-selected:hover{border-color:#6366f1}
.font-dropdown-selected::after{content:'â–¼';font-size:8px;margin-left:8px}
.font-dropdown-list{position:absolute;top:100%;left:0;right:0;background:#1e293b;border:1px solid #4b5563;border-radius:4px;margin-top:2px;max-height:200px;overflow-y:auto;z-index:100;display:none}
.font-dropdown.open .font-dropdown-list{display:block}
.font-dropdown-item{padding:8px 10px;cursor:pointer;color:white;font-size:14px}
.font-dropdown-item:hover{background:#374151}
.font-dropdown-item.selected{background:#4f46e5}
</style>
</head>
<body class="min-h-screen bg-slate-900 font-inter">
<div class="min-h-screen w-full flex flex-col">
<div id="toast" class="hidden fixed bottom-6 right-6 bg-emerald-600 text-white px-4 py-3 rounded-lg shadow-lg z-50 text-sm"></div>
<header class="bg-slate-800 border-b border-slate-700 px-6 py-4 shrink-0">
<h1 class="text-2xl font-bold text-white">Blank Card Designer - Single Line</h1>
</header>
<div class="flex-1 flex flex-col lg:flex-row gap-6 overflow-y-auto p-4 lg:p-6">
<div class="flex-1 flex flex-col items-center justify-center">
<div class="mb-4 flex gap-3 items-center">
<div class="flex items-center gap-2"><label class="text-xs text-slate-300 font-semibold">Card Colour:</label>
<select id="cardColor" class="bg-slate-700 text-white text-xs rounded px-2 py-1 border border-slate-600">
<option value="white">White</option><option value="brown">Brown (Texture)</option><option value="tan2">Brown Thinner</option>
<option value="orange">Orange</option><option value="yellow">Yellow</option><option value="blue">Blue</option>
<option value="green">Green</option><option value="pink">Pink</option>
</select></div>
<button id="previewBtn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition">Preview & Download</button>
<button id="clearBtn" class="px-4 py-2 bg-rose-600 hover:bg-rose-700 text-white rounded-lg font-medium transition">Clear All</button>
<div class="flex gap-1">
<button id="undoBtn" class="px-3 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg font-medium transition disabled:opacity-40 disabled:cursor-not-allowed" disabled title="Undo">â†¶ Undo</button>
<button id="redoBtn" class="px-3 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg font-medium transition disabled:opacity-40 disabled:cursor-not-allowed" disabled title="Redo">â†· Redo</button>
</div>
</div>
<div class="mb-3 flex gap-4 text-xs text-slate-400">
<span class="flex items-center gap-1"><span class="w-5 h-5 rounded-full bg-slate-700 text-white flex items-center justify-center text-xs font-bold">1</span> Choose card colour</span>
<span class="flex items-center gap-1"><span class="w-5 h-5 rounded-full bg-slate-700 text-white flex items-center justify-center text-xs font-bold">2</span> Type your text</span>
<span class="flex items-center gap-1"><span class="w-5 h-5 rounded-full bg-slate-700 text-white flex items-center justify-center text-xs font-bold">3</span> Adjust font & size</span>
<span class="flex items-center gap-1"><span class="w-5 h-5 rounded-full bg-slate-700 text-white flex items-center justify-center text-xs font-bold">4</span> Preview & Download</span>
</div>
<div id="cardCanvas" class="card-canvas">
<div id="designZone" class="design-zone" style="left:0px;top:96px;width:402px;height:47px;"><div class="zone-label">Design zone</div></div>
<div id="itemsContainer" style="position:absolute;width:100%;height:100%;"></div>
<div id="textWarning" class="hidden" style="position:absolute;left:0;top:148px;width:100%;text-align:center;font-size:11px;color:#f87171;font-weight:600;">Text is too long, please edit</div>
</div>
<p class="text-xs text-slate-400 mt-3">Card approximate size: 8.9 x 5.2 cm</p>
<p class="text-xs text-slate-400 mt-1">Yellow circle: Drag around to rotate</p>
<p class="text-xs text-slate-400 mt-1">Best with up to ~25 characters</p>
<p class="text-xs text-slate-400 mt-1">Colours on screen may appear slightly different in print.</p>
<button id="deleteItemBtn" class="hidden mt-4 px-4 py-2 bg-rose-600 hover:bg-rose-700 text-white rounded-lg font-medium transition flex items-center gap-2"><span>ðŸ—‘</span> Delete Item</button>
</div>
<div class="w-96 bg-slate-800 rounded-xl p-5 overflow-y-auto flex flex-col gap-6">
<div class="flex items-center justify-between mb-4">
<label class="text-xs text-slate-400 font-semibold">Mode</label>
<button id="advancedToggle" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-white text-xs rounded border border-slate-600 transition">Show Advanced</button>
</div>
<div id="advancedSection" class="hidden">
<div class="mb-6">
<div class="mb-3">
<label class="text-xs text-slate-400 font-semibold block mb-2">Shape Colour</label>
<div class="color-swatches" id="shapeSwatches"></div>
</div>
<h3 class="text-white font-semibold mb-2 text-sm">Shapes</h3>
<div class="library-grid" id="shapesLib"></div>
</div>
<div class="mb-6">
<div class="mb-3">
<label class="text-xs text-slate-400 font-semibold block mb-2">Icon Colour</label>
<div class="color-swatches" id="iconSwatches"></div>
</div>
<h3 class="text-white font-semibold mb-2 text-sm">Icons</h3>
<div class="library-grid" id="iconsLib"></div>
</div>
</div>
<div class="border-t border-slate-700 pt-4">
<h3 id="textSectionTitle" class="text-white font-semibold mb-3 text-sm">Add Text</h3>
<input type="text" id="textContent" placeholder="Enter text" class="w-full bg-slate-700 text-white rounded px-3 py-2 mb-2 text-sm">
<div class="grid grid-cols-2 gap-2 mb-3">
<div><label class="text-xs text-slate-400 block mb-1">Font</label>
<div class="font-dropdown" id="fontDropdown">
<button type="button" class="font-dropdown-btn" id="fontDropdownBtn">
<span id="fontDropdownLabel">Inter</span>
<span>â–¼</span>
</button>
<div class="font-dropdown-list" id="fontDropdownList"></div>
</div>
</div>
<div><label class="text-xs text-slate-400 block mb-1">Size (px)</label>
<input type="number" id="textSize" value="20" min="8" max="48" class="w-full bg-slate-700 text-white text-xs rounded px-2 py-1 border border-slate-600"></div>
</div>
<div class="mb-3">
<label class="text-xs text-slate-400 block mb-2">Colour</label>
<div class="color-swatches" id="textSwatches"></div>
</div>
<div class="flex gap-2">
<button id="textActionBtn" class="flex-1 px-3 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded font-medium text-sm transition">Add Text</button>
<button id="textCancelBtn" class="flex-1 px-3 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded font-medium text-sm transition hidden">Cancel Edit</button>
</div>
<button id="centerTextBtn" class="w-full mt-2 px-3 py-2 bg-teal-600 hover:bg-teal-700 text-white rounded font-medium text-sm transition hidden">âŠ¡ Center Text in Zone</button>
</div>
<div id="uploadSection" class="border-t border-slate-700 pt-4 hidden">
<h3 class="text-white font-semibold mb-3 text-sm">Upload Image</h3>
<input type="file" id="imageUpload" accept="image/*" class="hidden">
<button id="uploadBtn" class="w-full px-3 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded font-medium text-sm transition">Choose Image</button>
<p class="text-xs text-slate-400 mt-2 mb-3">Drag the uploaded image on lower-right corner (blue) to fit the image into the design zone.</p>
<div id="uploadPreview" class="hidden mt-3 bg-slate-700 rounded p-3">
<img id="previewImg" src="" alt="Preview" class="w-full h-24 object-contain rounded mb-2" draggable="true">
<div class="text-xs text-slate-400 text-center mb-2">Drag into Design Zone</div>
<button id="cancelUploadBtn" class="w-full px-2 py-1 bg-slate-600 hover:bg-slate-500 text-white rounded text-xs">Cancel</button>
</div>
</div>
</div>
</div>
</div>
<script>
const BROWN_TEXTURE_URL = "./assets/browntexture.png";
const CARD_COLOR_MAP={white:'#ffffff',brown:BROWN_TEXTURE_URL,tan2:'#CD9E6F',orange:'#CD7E66',yellow:'#E4CF60',blue:'#81CEE0',green:'#ACC27A',pink:'#E7B6CF'};
const FONT_LIST=[
{value:'inter',label:'Inter',family:"'Inter',sans-serif"},
{value:'poppins',label:'Poppins',family:"'Poppins',sans-serif"},
{value:'playfair',label:'Playfair Display',family:"'Playfair Display',serif"},
{value:'montserrat',label:'Montserrat',family:"'Montserrat',sans-serif"},
{value:'raleway',label:'Raleway',family:"'Raleway',sans-serif"},
{value:'great-vibes',label:'Great Vibes',family:"'Great Vibes',cursive"},
{value:'dancing-script',label:'Dancing Script',family:"'Dancing Script',cursive"},
{value:'pacifico',label:'Pacifico',family:"'Pacifico',cursive"},
{value:'sacramento',label:'Sacramento',family:"'Sacramento',cursive"},
{value:'allura',label:'Allura',family:"'Allura',cursive"},
{value:'satisfy',label:'Satisfy',family:"'Satisfy',cursive"},
{value:'lobster',label:'Lobster',family:"'Lobster',cursive"},
{value:'tangerine',label:'Tangerine',family:"'Tangerine',cursive"},
{value:'cookie',label:'Cookie',family:"'Cookie',cursive"}
];
const FONT_MAP={};
const FONT_CANVAS_MAP={};
FONT_LIST.forEach(f=>{
FONT_MAP[f.value]=f.family;
const weight=f.value==='great-vibes'||f.value==='pacifico'||f.value==='sacramento'||f.value==='allura'||f.value==='satisfy'||f.value==='lobster'||f.value==='cookie'?'400':'600';
FONT_CANVAS_MAP[f.value]=weight+' SIZE '+f.family.replace(/'/g,'');
});
FONT_CANVAS_MAP['tangerine']='700 SIZE Tangerine,cursive';

const PRESET_COLORS=['#000000','#ffffff','#06b6d4','#3b82f6','#6366f1','#8b5cf6','#ec4899','#f43f5e','#f59e0b','#eab308','#22c55e','#10b981','#14b8a6','#64748b'];
const SHAPES={circle:'<svg viewBox="0 0 40 40"><circle cx="20" cy="20" r="16" fill="currentColor"/></svg>',square:'<svg viewBox="0 0 40 40"><rect x="6" y="6" width="28" height="28" rx="2" fill="currentColor"/></svg>',triangle:'<svg viewBox="0 0 40 40"><polygon points="20,4 36,36 4,36" fill="currentColor"/></svg>',star:'<svg viewBox="0 0 40 40"><polygon points="20,4 24,16 36,16 27,23 31,35 20,28 9,35 13,23 4,16 16,16" fill="currentColor"/></svg>',hexagon:'<svg viewBox="0 0 40 40"><polygon points="20,6 32,13 32,27 20,34 8,27 8,13" fill="currentColor"/></svg>',diamond:'<svg viewBox="0 0 40 40"><polygon points="20,4 36,20 20,36 4,20" fill="currentColor"/></svg>',heart:'<svg viewBox="0 0 40 40"><path d="M20 35C20 35 4 24 4 14C4 8.5 8 4 12 4C15 4 18 6 20 9C22 6 25 4 28 4C32 4 36 8.5 36 14C36 24 20 35 20 35Z" fill="currentColor"/></svg>'};
const ICONS={phone:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>',email:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>',globe:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>',location:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>',user:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>',briefcase:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/><path d="M12 12v2"/></svg>',link:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>',building:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18"/><path d="M5 21V7l8-4v18"/><path d="M19 21V11l-6-4"/><path d="M9 9h1"/><path d="M9 13h1"/><path d="M9 17h1"/></svg>'};

let shapeColor='#06b6d4',iconColor='#06b6d4',textColor='#000000',selectedFont='inter';
let itemId=0,selectedItem=null,currentUploadData=null,editingTextItem=null,editingShapeItem=null;
let historyStack=[],historyIndex=-1,maxHistory=50,isRestoring=false;

// Build font dropdown
function buildFontDropdown(){
const list=document.getElementById('fontDropdownList');
list.innerHTML='';
FONT_LIST.forEach(font=>{
const item=document.createElement('div');
item.className='font-dropdown-item'+(font.value===selectedFont?' selected':'');
item.dataset.value=font.value;
item.textContent=font.label;
item.style.fontFamily=font.family;
item.addEventListener('click',()=>{
selectedFont=font.value;
document.getElementById('fontDropdownLabel').textContent=font.label;
document.getElementById('fontDropdownLabel').style.fontFamily=font.family;
list.classList.remove('open');
list.querySelectorAll('.font-dropdown-item').forEach(i=>i.classList.remove('selected'));
item.classList.add('selected');
});
list.appendChild(item);
});
}
buildFontDropdown();

document.getElementById('fontDropdownBtn').addEventListener('click',()=>{
document.getElementById('fontDropdownList').classList.toggle('open');
});
document.addEventListener('click',(e)=>{
if(!e.target.closest('.font-dropdown')){
document.getElementById('fontDropdownList').classList.remove('open');
}
});

function createColorSwatches(containerId,currentColor,onChange){
const container=document.getElementById(containerId);
container.innerHTML='';
PRESET_COLORS.forEach(color=>{
const swatch=document.createElement('div');
swatch.className='color-swatch'+(color===currentColor?' selected':'');
swatch.style.backgroundColor=color;
if(color==='#ffffff')swatch.style.border='2px solid #475569';
swatch.addEventListener('click',()=>{
container.querySelectorAll('.color-swatch').forEach(s=>s.classList.remove('selected'));
swatch.classList.add('selected');
const picker=container.querySelector('.color-picker-input');
if(picker)picker.value=color;
onChange(color);
});
container.appendChild(swatch);
});
const pickerWrapper=document.createElement('div');
pickerWrapper.className='color-picker-wrapper';
pickerWrapper.title='Custom colour';
const picker=document.createElement('input');
picker.type='color';
picker.value=currentColor;
picker.className='color-picker-input';
picker.addEventListener('input',(e)=>{
container.querySelectorAll('.color-swatch').forEach(s=>s.classList.remove('selected'));
onChange(e.target.value);
});
pickerWrapper.appendChild(picker);
container.appendChild(pickerWrapper);
}

function buildShapesLibrary(){
const lib=document.getElementById('shapesLib');
lib.innerHTML='';
for(const key in SHAPES){
const el=document.createElement('div');
el.className='library-item';
el.draggable=true;
el.innerHTML=SHAPES[key];
el.style.color=shapeColor;
((k)=>el.addEventListener('dragstart',(e)=>{
e.dataTransfer.effectAllowed='copy';
e.dataTransfer.setData('type','shape');
e.dataTransfer.setData('subtype',k);
}))(key);
lib.appendChild(el);
}
}

function buildIconsLibrary(){
const lib=document.getElementById('iconsLib');
lib.innerHTML='';
for(const key in ICONS){
const el=document.createElement('div');
el.className='library-item';
el.draggable=true;
el.innerHTML=ICONS[key];
el.style.color=iconColor;
((k)=>el.addEventListener('dragstart',(e)=>{
e.dataTransfer.effectAllowed='copy';
e.dataTransfer.setData('type','icon');
e.dataTransfer.setData('subtype',k);
}))(key);
lib.appendChild(el);
}
}

createColorSwatches('shapeSwatches',shapeColor,(c)=>{shapeColor=c;buildShapesLibrary();});
createColorSwatches('iconSwatches',iconColor,(c)=>{iconColor=c;buildIconsLibrary();});
createColorSwatches('textSwatches',textColor,(c)=>{textColor=c;});

buildShapesLibrary();
buildIconsLibrary();

function applyCardBackground(colorKey,element){const value=CARD_COLOR_MAP[colorKey]||'#ffffff';element.style.background=colorKey==='brown'?'url('+value+') center/cover no-repeat':value;}

function enterEditMode(item){
editingTextItem=item;
const textDiv=item.querySelector('.text-content');
document.getElementById('textSectionTitle').textContent='Edit Text';
document.getElementById('textContent').value=textDiv.textContent;
selectedFont=item.dataset.font;
const fontData=FONT_LIST.find(f=>f.value===selectedFont);
document.getElementById('fontDropdownLabel').textContent=fontData?fontData.label:'Inter';
document.getElementById('fontDropdownLabel').style.fontFamily=fontData?fontData.family:"'Inter',sans-serif";
buildFontDropdown();
document.getElementById('textSize').value=textDiv.style.fontSize.replace('px','');
textColor=item.dataset.color;
createColorSwatches('textSwatches',textColor,(c)=>{textColor=c;});
document.getElementById('textActionBtn').textContent='Update Text';
document.getElementById('textActionBtn').className='flex-1 px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded font-medium text-sm transition';
document.getElementById('textCancelBtn').classList.remove('hidden');
}

function exitEditMode(){
editingTextItem=null;
document.getElementById('textSectionTitle').textContent='Add Text';
document.getElementById('textContent').value='';
selectedFont='inter';
document.getElementById('fontDropdownLabel').textContent='Inter';
document.getElementById('fontDropdownLabel').style.fontFamily="'Inter',sans-serif";
buildFontDropdown();
document.getElementById('textSize').value='20';
textColor='#000000';
createColorSwatches('textSwatches',textColor,(c)=>{textColor=c;});
document.getElementById('textActionBtn').textContent='Add Text';
document.getElementById('textActionBtn').className='flex-1 px-3 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded font-medium text-sm transition';
document.getElementById('textCancelBtn').classList.add('hidden');
}
function enterShapeEditMode(item){
editingShapeItem=item;
const type=item.dataset.type;
const color=item.dataset.color;
if(type==='shape'){
document.querySelector('#shapeSwatches').parentElement.querySelector('label').textContent='Shape Colour (Editing)';
shapeColor=color;
createColorSwatches('shapeSwatches',shapeColor,(c)=>{
shapeColor=c;
buildShapesLibrary();
if(editingShapeItem && editingShapeItem.dataset.type==='shape'){
editingShapeItem.dataset.color=c;
editingShapeItem.querySelector('.item-content').style.color=c;
}
});
}else if(type==='icon'){
document.querySelector('#iconSwatches').parentElement.querySelector('label').textContent='Icon Colour (Editing)';
iconColor=color;
createColorSwatches('iconSwatches',iconColor,(c)=>{
iconColor=c;
buildIconsLibrary();
if(editingShapeItem && editingShapeItem.dataset.type==='icon'){
editingShapeItem.dataset.color=c;
editingShapeItem.querySelector('.item-content').style.color=c;
}
});
}
}

function exitShapeEditMode(){
editingShapeItem=null;
document.querySelector('#shapeSwatches').parentElement.querySelector('label').textContent='Shape Colour';
document.querySelector('#iconSwatches').parentElement.querySelector('label').textContent='Icon Colour';
}


function saveState(){
if(isRestoring)return;
const container=document.getElementById('itemsContainer');
const state=container.innerHTML;
// Remove any redo states if we're not at the end
if(historyIndex<historyStack.length-1){
historyStack=historyStack.slice(0,historyIndex+1);
}
historyStack.push(state);
if(historyStack.length>maxHistory){
historyStack.shift();
}else{
historyIndex++;
}
updateUndoRedoButtons();
}

function undo(){
if(historyIndex<=0)return;
historyIndex--;
restoreState(historyStack[historyIndex]);
updateUndoRedoButtons();
}

function redo(){
if(historyIndex>=historyStack.length-1)return;
historyIndex++;
restoreState(historyStack[historyIndex]);
updateUndoRedoButtons();
}

function restoreState(state){
isRestoring=true;
const container=document.getElementById('itemsContainer');
container.innerHTML=state;
// Re-attach event listeners to restored items
container.querySelectorAll('.placed-item').forEach(item=>{
item.addEventListener('mousedown',startDrag);
item.addEventListener('click',(e)=>{e.stopPropagation();selectItem(item);});
const resizeHandle=item.querySelector('.resize-handle');
const rotateHandle=item.querySelector('.rotate-handle');
if(resizeHandle)resizeHandle.addEventListener('mousedown',startResize);
if(rotateHandle)rotateHandle.addEventListener('mousedown',startRotate);
const textContent=item.querySelector('.text-content');
if(textContent)textContent.addEventListener('click',(e)=>{e.stopPropagation();selectItem(item);});
});
selectedItem=null;
exitEditMode();
exitShapeEditMode();
document.getElementById('deleteItemBtn').classList.add('hidden');
isRestoring=false;
}

function updateUndoRedoButtons(){
document.getElementById('undoBtn').disabled=historyIndex<=0;
document.getElementById('redoBtn').disabled=historyIndex>=historyStack.length-1;
}

// Initialize with empty state
setTimeout(()=>{saveState();},100);



function showToast(msg){const toast=document.getElementById('toast');toast.textContent=msg;toast.classList.remove('hidden');setTimeout(()=>toast.classList.add('hidden'),2500);}
function getZoneRect(){const zone=document.getElementById('designZone');return{x:parseInt(zone.style.left),y:parseInt(zone.style.top),w:parseInt(zone.style.width),h:parseInt(zone.style.height)};}

function createItem(type,subtype,x,y){
const container=document.getElementById('itemsContainer');
const id='item-'+(++itemId);
const zone=getZoneRect();
let size=40,content='',color='#6366f1';
if(type==='shape'){content=SHAPES[subtype]||'';color=shapeColor;}
else if(type==='icon'){content=ICONS[subtype]||'';color=iconColor;}
const item=document.createElement('div');
item.id=id;
item.className='placed-item';
item.dataset.type=type;
item.dataset.subtype=subtype;
item.dataset.rotation='0';
item.dataset.color=color;
item.style.pointerEvents='auto';
item.style.width=size+'px';
item.style.height=size+'px';
item.style.zIndex='50';
item.style.left=Math.max(zone.x,Math.min(x-size/2,zone.x+zone.w-size))+'px';
item.style.top=Math.max(zone.y,Math.min(y-size/2,zone.y+zone.h-size))+'px';
const contentDiv=document.createElement('div');
contentDiv.className='item-content';
contentDiv.style.color=color;
contentDiv.innerHTML=content;
item.appendChild(contentDiv);
const resizeHandle=document.createElement('div');
resizeHandle.className='resize-handle';
item.appendChild(resizeHandle);
const rotateHandle=document.createElement('div');
rotateHandle.className='rotate-handle';
item.appendChild(rotateHandle);
item.addEventListener('mousedown',startDrag);
item.addEventListener('click',()=>selectItem(item));
resizeHandle.addEventListener('mousedown',startResize);
rotateHandle.addEventListener('mousedown',startRotate);
container.appendChild(item);
selectItem(item);
saveState();
return item;
}

function createTextItem(text,size,color,font,x,y){
const container=document.getElementById('itemsContainer');
const id='item-'+(++itemId);
const zone=getZoneRect();
const item=document.createElement('div');
item.id=id;
item.className='placed-item';
item.dataset.type='text';
item.dataset.font=font;
item.dataset.color=color;
item.dataset.rotation='0';
item.style.pointerEvents='auto';
item.style.zIndex='50';
const textDiv=document.createElement('span');
textDiv.className='text-content';
textDiv.textContent=text;
textDiv.style.fontSize=size+'px';
textDiv.style.color=color;
textDiv.style.fontFamily=FONT_MAP[font]||FONT_MAP.inter;
textDiv.style.fontWeight='600';
textDiv.style.pointerEvents='auto';
textDiv.style.display='block';
item.appendChild(textDiv);
item.style.left=Math.max(0,Math.min(x-100,402-200))+'px';
item.style.top=zone.y+'px';
const rotateHandle=document.createElement('div');
rotateHandle.className='rotate-handle';
item.appendChild(rotateHandle);
item.addEventListener('mousedown',startDrag);
item.addEventListener('click',(e)=>{e.stopPropagation();selectItem(item);});
textDiv.addEventListener('click',(e)=>{e.stopPropagation();selectItem(item);});
rotateHandle.addEventListener('mousedown',startRotate);
container.appendChild(item);
requestAnimationFrame(()=>{
const textHeight=item.offsetHeight;
const centerY=zone.y+Math.round((zone.h-textHeight)/2);
item.style.top=centerY+'px';
});
selectItem(item);
// Auto-shrink if too wide
requestAnimationFrame(()=>{
const zone = getZoneRect();
const textEl = item.querySelector('.text-content');
let fontSize = parseInt(textEl.style.fontSize);
const minFontSize = 10;
while(item.offsetWidth > zone.w && fontSize > minFontSize){
fontSize -= 1;
textEl.style.fontSize = fontSize + 'px';
}
// Re-center vertically after shrink
const textHeight = item.offsetHeight;
const centerY = zone.y + Math.round((zone.h - textHeight) / 2);
item.style.top = centerY + 'px';
});
saveState();
return item;
}

function createUploadedItem(imageData,x,y){
const container=document.getElementById('itemsContainer');
const id='item-'+(++itemId);
const zone=getZoneRect();
const maxSize=120;
const item=document.createElement('div');
item.id=id;
item.className='placed-item';
item.dataset.type='image';
item.dataset.rotation='0';
item.style.pointerEvents='auto';
item.style.width=maxSize+'px';
item.style.height=maxSize+'px';
item.style.overflow='hidden';
item.style.borderRadius='4px';
item.style.zIndex='50';
item.style.display='flex';
item.style.alignItems='center';
item.style.justifyContent='center';
const img=document.createElement('img');
img.src=imageData;
img.style.width='100%';
img.style.height='100%';
img.style.objectFit='cover';
img.style.pointerEvents='none';
item.appendChild(img);
item.style.left=Math.max(zone.x,Math.min(x-maxSize/2,zone.x+zone.w-maxSize))+'px';
item.style.top=Math.max(zone.y,Math.min(y-maxSize/2,zone.y+zone.h-maxSize))+'px';
const resizeHandle=document.createElement('div');
resizeHandle.className='resize-handle';
item.appendChild(resizeHandle);
const rotateHandle=document.createElement('div');
rotateHandle.className='rotate-handle';
item.appendChild(rotateHandle);
item.addEventListener('mousedown',startDrag);
item.addEventListener('click',()=>selectItem(item));
resizeHandle.addEventListener('mousedown',startResize);
rotateHandle.addEventListener('mousedown',startRotate);
container.appendChild(item);
selectItem(item);
saveState();
return item;
}

function selectItem(item){
if(selectedItem)selectedItem.classList.remove('selected');
selectedItem=item;
item.classList.add('selected');
document.getElementById('deleteItemBtn').classList.remove('hidden');
if(item.dataset.type==='text'){
enterEditMode(item);
exitShapeEditMode();
}else if(item.dataset.type==='shape'||item.dataset.type==='icon'){
exitEditMode();
enterShapeEditMode(item);
}else{
exitEditMode();
exitShapeEditMode();
}
}
function startDrag(e){if(e.button!==0||e.target.classList.contains('rotate-handle'))return;e.preventDefault();e.stopPropagation();const item=e.currentTarget;selectItem(item);const zone=getZoneRect();const startX=e.clientX,startY=e.clientY;const itemStartX=parseInt(item.style.left)||0,itemStartY=parseInt(item.style.top)||0;function onMove(e){let x=itemStartX+(e.clientX-startX),y=itemStartY+(e.clientY-startY);x=Math.max(zone.x,Math.min(x,zone.x+zone.w-item.offsetWidth));y=Math.max(zone.y,Math.min(y,zone.y+zone.h-item.offsetHeight));item.style.left=x+'px';item.style.top=y+'px';}function onEnd(){document.removeEventListener('mousemove',onMove);document.removeEventListener('mouseup',onEnd);saveState();}document.addEventListener('mousemove',onMove);document.addEventListener('mouseup',onEnd);}
function startRotate(e){e.preventDefault();e.stopPropagation();const item=e.currentTarget.closest('.placed-item');const rect=item.getBoundingClientRect();const centerX=rect.left+rect.width/2,centerY=rect.top+rect.height/2;const startAngle=Math.atan2(e.clientY-centerY,e.clientX-centerX)*180/Math.PI;const currentRotation=parseFloat(item.dataset.rotation)||0;function onMove(e){e.preventDefault();const angle=Math.atan2(e.clientY-centerY,e.clientX-centerX)*180/Math.PI;const newRotation=currentRotation+(angle-startAngle);item.dataset.rotation=newRotation;item.style.transform='rotate('+newRotation+'deg)';}function onEnd(){document.removeEventListener('mousemove',onMove);document.removeEventListener('mouseup',onEnd);saveState();}document.addEventListener('mousemove',onMove);document.addEventListener('mouseup',onEnd);}
function startResize(e){e.preventDefault();e.stopPropagation();const item=e.currentTarget.closest('.placed-item');const zone=getZoneRect();const startX=e.clientX,startY=e.clientY;const startWidth=item.offsetWidth;const itemX=parseInt(item.style.left),itemY=parseInt(item.style.top);const minSize=20;function onMove(e){const deltaX=e.clientX-startX;const deltaY=e.clientY-startY;const maxDelta=Math.max(deltaX,deltaY);let newSize=Math.max(minSize,startWidth+maxDelta);const maxSizeInZone=Math.min(zone.w-(itemX-zone.x),zone.h-(itemY-zone.y));newSize=Math.min(newSize,maxSizeInZone);item.style.width=newSize+'px';item.style.height=newSize+'px';}function onEnd(){document.removeEventListener('mousemove',onMove);document.removeEventListener('mouseup',onEnd);saveState();}document.addEventListener('mousemove',onMove);document.addEventListener('mouseup',onEnd);}

document.getElementById('cardColor').addEventListener('change',(e)=>applyCardBackground(e.target.value,document.getElementById('cardCanvas')));
const canvas=document.getElementById('cardCanvas');
const zone=document.getElementById('designZone');
canvas.addEventListener('dragover',(e)=>{e.preventDefault();e.dataTransfer.dropEffect='copy';zone.style.background='rgba(99,102,241,0.2)';});
canvas.addEventListener('dragleave',(e)=>{e.preventDefault();zone.style.background='rgba(99,102,241,0.05)';});
canvas.addEventListener('drop',(e)=>{e.preventDefault();e.stopPropagation();zone.style.background='rgba(99,102,241,0.05)';const type=e.dataTransfer.getData('type'),subtype=e.dataTransfer.getData('subtype');if(!type)return;const canvasRect=canvas.getBoundingClientRect();const x=e.clientX-canvasRect.left,y=e.clientY-canvasRect.top;if(type==='uploaded-image'&&currentUploadData){createUploadedItem(currentUploadData,x,y);showToast('Image added to card');}else if(type==='shape'||type==='icon'){createItem(type,subtype,x,y);showToast(type.charAt(0).toUpperCase()+type.slice(1)+' added');}});

document.getElementById('textActionBtn').addEventListener('click',()=>{
const text=document.getElementById('textContent').value.trim();
if(!text){showToast('Enter text');return;}
if(editingTextItem){
const textDiv=editingTextItem.querySelector('.text-content');
const newSize=parseInt(document.getElementById('textSize').value);
textDiv.textContent=text;
textDiv.style.fontSize=newSize+'px';
textDiv.style.fontFamily=FONT_MAP[selectedFont]||FONT_MAP.inter;
textDiv.style.color=textColor;
editingTextItem.dataset.font=selectedFont;
editingTextItem.dataset.color=textColor;
const zone=getZoneRect();
requestAnimationFrame(()=>{
const textHeight=editingTextItem.offsetHeight;
const centerY=zone.y+Math.round((zone.h-textHeight)/2);
editingTextItem.style.top=centerY+'px';
});
showToast('Text updated');
exitEditMode();
}else{
const zoneRect=getZoneRect();
createTextItem(text,parseInt(document.getElementById('textSize').value)||16,textColor,selectedFont,zoneRect.x+zoneRect.w/2,zoneRect.y+zoneRect.h/2);
exitEditMode();
showToast('Text added');
}
});

document.getElementById('textCancelBtn').addEventListener('click',exitEditMode);
document.getElementById('textContent').addEventListener('keypress',(e)=>{if(e.key==='Enter')document.getElementById('textActionBtn').click();});
document.getElementById('uploadBtn').addEventListener('click',()=>document.getElementById('imageUpload').click());
document.getElementById('imageUpload').addEventListener('change',(e)=>{const file=e.target.files[0];if(!file)return;if(file.size>5*1024*1024){showToast('File too large (max 5MB)');return;}const reader=new FileReader();reader.onload=(event)=>{currentUploadData=event.target.result;document.getElementById('previewImg').src=currentUploadData;document.getElementById('uploadPreview').classList.remove('hidden');};reader.readAsDataURL(file);});
document.getElementById('previewImg').addEventListener('dragstart',(e)=>{e.dataTransfer.effectAllowed='copy';e.dataTransfer.setData('type','uploaded-image');});
document.getElementById('cancelUploadBtn').addEventListener('click',()=>{currentUploadData=null;document.getElementById('imageUpload').value='';document.getElementById('uploadPreview').classList.add('hidden');});
document.getElementById('clearBtn').addEventListener('click',()=>{document.getElementById('itemsContainer').innerHTML='';selectedItem=null;exitEditMode();exitShapeEditMode();document.getElementById('deleteItemBtn').classList.add('hidden');saveState();});
document.getElementById('deleteItemBtn').addEventListener('click',()=>{if(selectedItem){selectedItem.remove();selectedItem=null;exitEditMode();exitShapeEditMode();document.getElementById('deleteItemBtn').classList.add('hidden');saveState();showToast('Item deleted');}});

async function renderDesignZoneManual(colorKey,transparent,callback){
const zoneRect=getZoneRect();
const scale=2;
const canvas=document.createElement('canvas');
canvas.width=zoneRect.w*scale;
canvas.height=zoneRect.h*scale;
const ctx=canvas.getContext('2d');

if(!transparent){
if(colorKey==='brown'){
const img=new Image();
img.onload=()=>{
ctx.drawImage(img,zoneRect.x*scale,zoneRect.y*scale,zoneRect.w*scale,zoneRect.h*scale,0,0,zoneRect.w*scale,zoneRect.h*scale);
drawItems();
};
img.src=BROWN_TEXTURE_URL;
return;
}else{
ctx.fillStyle=CARD_COLOR_MAP[colorKey]||'#ffffff';
ctx.fillRect(0,0,canvas.width,canvas.height);
}
}

drawItems();

function drawItems(){
const items=document.getElementById('itemsContainer').querySelectorAll('.placed-item');
const promises=[];

items.forEach(item=>{
const itemX=(parseInt(item.style.left)-zoneRect.x)*scale;
const itemY=(parseInt(item.style.top)-zoneRect.y)*scale;
const rotation=parseFloat(item.dataset.rotation)||0;

if(item.dataset.type==='text'){
const textEl=item.querySelector('.text-content');
const text=textEl.textContent;
const fontSize=parseInt(textEl.style.fontSize)*scale;
const color=item.dataset.color;
const fontKey=item.dataset.font;
const fontStr=(FONT_CANVAS_MAP[fontKey]||FONT_CANVAS_MAP.inter).replace('SIZE',fontSize+'px');

ctx.save();
const centerX=itemX+item.offsetWidth*scale/2;
const centerY=itemY+item.offsetHeight*scale/2;
ctx.translate(centerX,centerY);
ctx.rotate(rotation*Math.PI/180);
ctx.font=fontStr;
ctx.fillStyle=color;
ctx.textBaseline='middle';
ctx.fillText(text,-item.offsetWidth*scale/2+0,0);
ctx.restore();
}else if(item.dataset.type==='image'){
const imgEl=item.querySelector('img');
if(imgEl){
const p=new Promise(resolve=>{
const img=new Image();
img.crossOrigin='anonymous';
img.onload=()=>{
ctx.save();
const centerX=itemX+item.offsetWidth*scale/2;
const centerY=itemY+item.offsetHeight*scale/2;
ctx.translate(centerX,centerY);
ctx.rotate(rotation*Math.PI/180);
ctx.drawImage(img,-item.offsetWidth*scale/2,-item.offsetHeight*scale/2,item.offsetWidth*scale,item.offsetHeight*scale);
ctx.restore();
resolve();
};
img.src=imgEl.src;
});
promises.push(p);
}
}else{
const p=new Promise(resolve=>{
const clone=item.cloneNode(true);
clone.style.position='absolute';
clone.style.left='-9999px';
clone.style.transform='none';
clone.querySelectorAll('.resize-handle,.rotate-handle').forEach(h=>h.remove());
clone.classList.remove('selected');
document.body.appendChild(clone);
html2canvas(clone,{scale:scale,backgroundColor:null,logging:false}).then(itemCanvas=>{
document.body.removeChild(clone);
ctx.save();
const centerX=itemX+item.offsetWidth*scale/2;
const centerY=itemY+item.offsetHeight*scale/2;
ctx.translate(centerX,centerY);
ctx.rotate(rotation*Math.PI/180);
ctx.drawImage(itemCanvas,-item.offsetWidth*scale/2,-item.offsetHeight*scale/2);
ctx.restore();
resolve();
});
});
promises.push(p);
}
});

Promise.all(promises).then(()=>callback(canvas));
}
}

document.getElementById('previewBtn').addEventListener('click',()=>{
const previewModal=document.createElement('div');
previewModal.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;padding:20px;overflow-y:auto;';
const container=document.createElement('div');
container.style.cssText='display:flex;flex-direction:column;align-items:center;gap:16px;max-width:100%;';
const title=document.createElement('h2');
title.textContent='Preview & Download';
title.style.cssText='color:white;margin:0;font-size:24px;font-weight:bold;';
container.appendChild(title);
const controlsRow=document.createElement('div');
controlsRow.style.cssText='display:flex;align-items:center;gap:15px;flex-wrap:wrap;justify-content:center;';
const colorWrapper=document.createElement('div');
colorWrapper.style.cssText='display:flex;align-items:center;gap:8px;';
const colorLabel=document.createElement('label');
colorLabel.textContent='Background:';
colorLabel.style.cssText='color:white;font-size:14px;font-weight:600;';
colorWrapper.appendChild(colorLabel);
const colorSelect=document.createElement('select');
colorSelect.id='previewColorSelect';
colorSelect.style.cssText='background:#334155;color:white;border:1px solid #475569;border-radius:4px;padding:6px 10px;font-size:14px;cursor:pointer;';
const colors=['white','brown','tan2','orange','yellow','blue','green','pink'];
const colorLabels={white:'White',brown:'Brown (Texture)',tan2:'Brown Thinner',orange:'Orange',yellow:'Yellow',blue:'Blue',green:'Green',pink:'Pink'};
colors.forEach(color=>{const option=document.createElement('option');option.value=color;option.textContent=colorLabels[color];colorSelect.appendChild(option);});
colorSelect.value=document.getElementById('cardColor').value;
colorWrapper.appendChild(colorSelect);
controlsRow.appendChild(colorWrapper);
const transparentWrapper=document.createElement('div');
transparentWrapper.style.cssText='display:flex;align-items:center;gap:6px;';
const transparentCheckbox=document.createElement('input');
transparentCheckbox.type='checkbox';
transparentCheckbox.id='transparentBg';
transparentCheckbox.style.cssText='width:16px;height:16px;cursor:pointer;';
const transparentLabel=document.createElement('label');
transparentLabel.textContent='Transparent (for printing)';
transparentLabel.htmlFor='transparentBg';
transparentLabel.style.cssText='color:white;font-size:14px;cursor:pointer;';
transparentWrapper.appendChild(transparentCheckbox);
transparentWrapper.appendChild(transparentLabel);
controlsRow.appendChild(transparentWrapper);
container.appendChild(controlsRow);
const previewWrapper=document.createElement('div');
previewWrapper.id='previewWrapper';
previewWrapper.style.cssText='padding:10px;border-radius:8px;background:#1e293b;';
const previewImg=document.createElement('img');
previewImg.id='previewModalImg';
previewImg.style.cssText='border-radius:4px;box-shadow:0 10px 40px rgba(0,0,0,0.5);max-width:90vw;object-fit:contain;';
previewWrapper.appendChild(previewImg);
container.appendChild(previewWrapper);
const btnRow=document.createElement('div');
btnRow.style.cssText='display:flex;gap:12px;flex-wrap:wrap;justify-content:center;';
const downloadBtn=document.createElement('button');
downloadBtn.textContent='Download Design';
downloadBtn.style.cssText='background:#4f46e5;color:white;border:none;padding:12px 24px;border-radius:6px;cursor:pointer;font-size:16px;font-weight:600;';
downloadBtn.addEventListener('mouseenter',()=>{downloadBtn.style.background='#4338ca';});
downloadBtn.addEventListener('mouseleave',()=>{downloadBtn.style.background='#4f46e5';});
downloadBtn.addEventListener('click',()=>{
renderDesignZoneManual(colorSelect.value,true,(canvasResult)=>{
const link=document.createElement('a');
link.download='design.png';
link.href=canvasResult.toDataURL('image/png');
link.click();
showToast('Design downloaded!');
});
});
btnRow.appendChild(downloadBtn);
const closeBtn=document.createElement('button');
closeBtn.textContent='Close';
closeBtn.style.cssText='background:white;color:black;border:none;padding:12px 24px;border-radius:6px;cursor:pointer;font-size:16px;font-weight:600;';
closeBtn.addEventListener('click',()=>previewModal.remove());
btnRow.appendChild(closeBtn);
container.appendChild(btnRow);
const footerText=document.createElement('p');
footerText.textContent='Download your design and send to us! (Note: Image is transparent)';
footerText.style.cssText='color:#94a3b8;font-size:14px;margin-top:8px;';
container.appendChild(footerText);
previewModal.appendChild(container);
document.body.appendChild(previewModal);
function updatePreview(){
const colorKey=colorSelect.value;
const transparent=transparentCheckbox.checked;
if(transparent){
previewWrapper.className='checkerboard';
previewWrapper.style.background='';
}else{
previewWrapper.className='';
previewWrapper.style.background='#1e293b';
}
renderDesignZoneManual(colorKey,transparent,(canvasResult)=>{
previewImg.src=canvasResult.toDataURL();
});
}
colorSelect.addEventListener('change',updatePreview);
transparentCheckbox.addEventListener('change',updatePreview);
updatePreview();
});

document.getElementById('undoBtn').addEventListener('click',undo);
document.getElementById('redoBtn').addEventListener('click',redo);

// Keyboard shortcuts for undo/redo
document.addEventListener('keydown',(e)=>{
if((e.ctrlKey||e.metaKey)&&e.key==='z'){
e.preventDefault();
if(e.shiftKey){redo();}else{undo();}
}
if((e.ctrlKey||e.metaKey)&&e.key==='y'){
e.preventDefault();
redo();
}
});



// Deselect items when clicking outside of items
document.getElementById('cardCanvas').addEventListener('mousedown',(e)=>{
// Check if we clicked on an item or its children
let target = e.target;
let clickedOnItem = false;
while(target && target !== document.getElementById('cardCanvas')){
if(target.classList && target.classList.contains('placed-item')){
clickedOnItem = true;
break;
}
target = target.parentElement;
}
if(!clickedOnItem && selectedItem){
selectedItem.classList.remove('selected');
selectedItem = null;
exitEditMode();
exitShapeEditMode();
document.getElementById('deleteItemBtn').classList.add('hidden');
}
});


// Advanced mode toggle
let advancedMode = false;
document.getElementById('advancedToggle').addEventListener('click', () => {
advancedMode = !advancedMode;
const advSection = document.getElementById('advancedSection');
const uploadSection = document.getElementById('uploadSection');
const toggleBtn = document.getElementById('advancedToggle');
if(advancedMode){
advSection.classList.remove('hidden');
uploadSection.classList.remove('hidden');
toggleBtn.textContent = 'Hide Advanced';
toggleBtn.classList.add('bg-indigo-600');
toggleBtn.classList.remove('bg-slate-700');
}else{
advSection.classList.add('hidden');
uploadSection.classList.add('hidden');
toggleBtn.textContent = 'Show Advanced';
toggleBtn.classList.remove('bg-indigo-600');
toggleBtn.classList.add('bg-slate-700');
}
});


// Center Text button - show when text item is selected
function updateCenterButtonVisibility(){
const centerBtn = document.getElementById('centerTextBtn');
if(selectedItem && selectedItem.dataset.type === 'text'){
centerBtn.classList.remove('hidden');
} else {
centerBtn.classList.add('hidden');
}
}

document.getElementById('centerTextBtn').addEventListener('click', () => {
if(!selectedItem || selectedItem.dataset.type !== 'text') return;
const zone = getZoneRect();
const itemWidth = selectedItem.offsetWidth;
const itemHeight = selectedItem.offsetHeight;
const centerX = zone.x + (zone.w - itemWidth) / 2;
const centerY = zone.y + (zone.h - itemHeight) / 2;
selectedItem.style.left = Math.round(centerX) + 'px';
selectedItem.style.top = Math.round(centerY) + 'px';
saveState();
showToast('Text centered!');
});

// Auto-shrink text if too long
function autoShrinkText(item){
const zone = getZoneRect();
const textEl = item.querySelector('.text-content');
let fontSize = parseInt(textEl.style.fontSize);
const minFontSize = 10;

// Check if text exceeds zone width
while(item.offsetWidth > zone.w && fontSize > minFontSize){
fontSize -= 1;
textEl.style.fontSize = fontSize + 'px';
}
}

// Override selectItem to show/hide center button
const originalSelectItem = selectItem;
selectItem = function(item){
originalSelectItem(item);
updateCenterButtonVisibility();
};

// Also update when deselecting
const originalCardCanvasMousedown = document.getElementById('cardCanvas').onmousedown;
document.getElementById('cardCanvas').addEventListener('mousedown', (e) => {
setTimeout(updateCenterButtonVisibility, 10);
});


// Check if any text exceeds zone width and show warning
function checkTextOverflow(){
const zone = getZoneRect();
const warning = document.getElementById('textWarning');
const items = document.getElementById('itemsContainer').querySelectorAll('.placed-item[data-type="text"]');
let hasOverflow = false;

items.forEach(item => {
if(item.offsetWidth > zone.w){
hasOverflow = true;
}
});

if(hasOverflow){
warning.classList.remove('hidden');
} else {
warning.classList.add('hidden');
}
}

// Call checkTextOverflow after text operations
const originalCreateTextItem = createTextItem;
createTextItem = function(text, size, color, font, x, y){
const item = originalCreateTextItem(text, size, color, font, x, y);
setTimeout(checkTextOverflow, 50);
return item;
};

// Check on text update too
const origTextActionHandler = document.getElementById('textActionBtn').onclick;
document.getElementById('textActionBtn').addEventListener('click', () => {
setTimeout(checkTextOverflow, 50);
});

// Check after undo/redo
const originalUndo = undo;
undo = function(){
originalUndo();
setTimeout(checkTextOverflow, 50);
};

const originalRedo = redo;
redo = function(){
originalRedo();
setTimeout(checkTextOverflow, 50);
};

// Check after delete
document.getElementById('deleteItemBtn').addEventListener('click', () => {
setTimeout(checkTextOverflow, 50);
});

// Check after clear
document.getElementById('clearBtn').addEventListener('click', () => {
setTimeout(checkTextOverflow, 50);
});

</script>
</body>
</html>
